<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Class Forge - Beta 1.2</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>

    <style>
        :root { --bg-dark: #050505; --card-bg: #141414; --gold: #d4af37; --gold-glow: #ffd700; --green: #2ecc71; --red: #e74c3c; --text-main: #e0e0e0; --fire-core: #ffeba7; --fire-mid: #ff7b00; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background-color: var(--bg-dark); background-image: linear-gradient(335deg, #0f0f0f 23px, transparent 23px), linear-gradient(155deg, #0f0f0f 23px, transparent 23px); background-size: 58px 58px; color: var(--text-main); height: 100dvh; overflow: hidden; display: flex; flex-direction: column; align-items: center; transition: background 1s ease; }
        body.boss-mode { background-color: #1a0505; background-image: linear-gradient(335deg, #2a0000 23px, transparent 23px), linear-gradient(155deg, #2a0000 23px, transparent 23px); box-shadow: inset 0 0 150px #ff0000; }
        h1, h2, h3 { font-family: 'Cinzel', serif; letter-spacing: 2px; }

        /* CONFETTI */
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; display: none; }

        /* TORCH */
        .torch-container { position: fixed; top: 20%; width: 100px; height: 300px; z-index: 0; pointer-events: none; }
        .torch-left { left: 20px; } .torch-right { right: 20px; }
        .torch-flame { width: 30px; height: 50px; background: linear-gradient(0deg, var(--fire-core), var(--fire-mid), transparent); border-radius: 50% 50% 20% 20%; position: absolute; left: 35px; top: 0; filter: blur(5px); animation: flicker 0.5s infinite alternate; box-shadow: 0 0 40px 10px rgba(255, 100, 0, 0.4); }
        .torch-handle { width: 10px; height: 100px; background: #444; position: absolute; left: 45px; top: 40px; background: linear-gradient(90deg, #222, #555, #222); transform: perspective(10px) rotateX(5deg); }
        @keyframes flicker { 0% { transform: scale(1) skewX(-2deg); opacity: 0.9; } 100% { transform: scale(0.95) skewX(-1deg); opacity: 0.8; } }

        /* UI */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { width: 300px; padding: 40px; text-align: center; border: 1px solid #333; background: linear-gradient(180deg, #111, #050505); box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        .hud-bar { position: fixed; top: 10px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.9); padding: 8px 12px; border: 2px solid var(--gold); border-radius: 4px; display: none; align-items: center; gap: 8px; }
        .hp-track { width: 120px; height: 10px; background: #222; border: 1px solid #555; transform: skewX(-10deg); }
        .hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #c0392b, #e74c3c); transition: width 0.4s ease-out; }

        .config-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; padding: 15px; overflow-y: auto; }
        .config-box { width: 100%; max-width: 500px; padding: 20px; background: #111; border: 2px solid var(--gold); box-shadow: 0 0 20px rgba(212, 175, 55, 0.1); }
        input, select, textarea { width: 100%; background: #080808; border: 1px solid #444; color: var(--gold); padding: 12px; margin: 5px 0 15px 0; font-family: 'Roboto', sans-serif; font-size: 16px; border-radius: 4px; }
        textarea { height: 60px; resize: none; }
        .btn-main { width: 100%; padding: 16px; font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.1rem; background: linear-gradient(180deg, #b8860b, #8b6508); color: #000; border: 1px solid #ffd700; cursor: pointer; text-transform: uppercase; margin-top: 10px; border-radius: 4px; transition: 0.2s; }
        .btn-main:hover { filter: brightness(1.1); transform: scale(1.02); }
        .btn-sec { background: #222; border-color: #444; color: #aaa; font-size: 0.9rem; margin-top: 10px; }

        .dashboard-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a0a; z-index: 3000; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .stat-card { background: #151515; padding: 20px; border: 1px solid #333; text-align: center; }
        .stat-num { font-size: 2rem; color: var(--gold); font-weight: bold; }
        .student-list { width: 100%; border-collapse: collapse; color: #ccc; }
        .student-list th { text-align: left; color: #888; padding: 10px; border-bottom: 1px solid #333; }
        .student-list td { padding: 15px 10px; border-bottom: 1px solid #222; }
        .grade-good { color: var(--green); } .grade-bad { color: var(--red); }

        #game-area { width: 100%; height: 100%; display: none; position: relative; z-index: 10; overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; white-space: nowrap; padding: 0 20px; }
        .map-flex { display: flex; align-items: center; height: 100%; gap: 30px; padding-left: 50vw; padding-right: 50vw; }
        .card { width: 220px; height: 320px; flex-shrink: 0; background: var(--card-bg); border: 2px solid #444; display: inline-flex; flex-direction: column; align-items: center; justify-content: flex-start; position: relative; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5); white-space: normal; transition: transform 0.2s; padding: 15px; }
        .card:active { transform: scale(0.95); }
        .card.locked { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
        .card.cleared { border-color: var(--green); filter: grayscale(1) brightness(0.5); }
        .card.cleared::after { content: "VENCIDO"; position: absolute; top: 40%; color: var(--green); font-family: 'Cinzel'; font-weight: bold; font-size: 2rem; transform: rotate(-15deg); text-shadow: 0 0 10px #000; }
        .card-icon { font-size: 3rem; margin-bottom: 10px; margin-top: 20px; }
        .card-title { font-size: 1.1rem; color: var(--gold); text-align: center; margin-bottom: 10px; font-weight: bold; }
        .card-desc { font-size: 0.8rem; color: #888; text-align: center; font-style: italic; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
        .connector { width: 30px; height: 4px; background: #333; flex-shrink: 0; }

        .battle-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1500; display: none; justify-content: center; align-items: center; padding: 10px; }
        .battle-window { width: 100%; max-width: 650px; height: 90vh; background: #0f0f0f; border: 1px solid var(--gold); display: flex; flex-direction: column; animation: modalOpen 0.3s ease-out; transition: border 0.3s, box-shadow 0.3s; }
        @keyframes modalOpen { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .battle-header { padding: 15px; background: rgba(212, 175, 55, 0.1); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .battle-body { padding: 20px; overflow-y: auto; flex: 1; }
        .lore-box { background: #111; border-left: 3px solid var(--gold); padding: 15px; margin-bottom: 20px; font-style: italic; color: #ccc; font-size: 0.95rem; line-height: 1.4; }
        .combat-selector { display: flex; flex-direction: column; gap: 10px; }
        .combat-option { background: #1a1a1a; border: 1px solid #333; display: flex; align-items: center; gap: 20px; padding: 20px; cursor: pointer; min-height: 80px; transition: 0.2s; }
        .combat-option:hover { border-color: var(--gold); background: #222; }
        .combat-icon { font-size: 2rem; }
        .combat-info h3 { margin: 0; color: var(--gold); font-size: 1rem; }
        .combat-info p { margin: 5px 0 0 0; color: #888; font-size: 0.8rem; }
        .question-text { font-size: 1.2rem; line-height: 1.5; margin-bottom: 20px; text-align: left; font-weight: bold; color: #fff; }
        .quiz-btn { width: 100%; padding: 18px; margin-bottom: 10px; background: #1a1a1a; border: 1px solid #333; color: #ddd; text-align: left; cursor: pointer; font-size: 1rem; border-radius: 4px; transition: 0.2s; }
        .quiz-btn:hover { background: #252525; border-color: #666; }
        .word-bank { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 20px; }
        .word-slot { background: #222; border: 1px solid #555; padding: 10px 14px; cursor: pointer; border-radius: 4px; user-select: none; }
        .answer-area { background: #000; border-bottom: 2px solid var(--gold); min-height: 50px; display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; justify-content: center; }
        #feedback-area { margin-top: 20px; padding: 15px; text-align: center; font-weight: bold; font-size: 1.1rem; border-radius: 4px; min-height: 20px; }
        .correct { background: rgba(46, 204, 113, 0.2) !important; border-color: var(--green) !important; color: var(--green) !important; }
        .wrong { background: rgba(231, 76, 60, 0.2) !important; border-color: var(--red) !important; animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .hidden { display: none !important; }
        .loader { font-size: 3rem; animation: spin 2s infinite linear; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .torch-container { display: none; } }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>
    <div class="torch-container torch-left"><div class="torch-flame"></div><div class="torch-handle"></div></div>
    <div class="torch-container torch-right"><div class="torch-flame"></div><div class="torch-handle"></div></div>

    <div id="login-screen" class="login-overlay">
        <h1 style="color: var(--gold); font-size: 3rem; margin-bottom: 10px;">CLASS FORGE</h1>
        <div class="login-box">
            <h3 style="color:#666; margin-bottom: 20px; font-family: Roboto;">ACESSO RESTRITO</h3>
            <input type="email" placeholder="E-mail" value="professor@escola.com">
            <input type="password" placeholder="Senha" value="********">
            <button class="btn-main" onclick="performLogin()">ENTRAR</button>
            <p style="color:#444; font-size:0.8rem; margin-top:20px;">Beta 1.2 - All Rights Reserved</p>
        </div>
    </div>

    <div id="game-hud" class="hud-bar">
        <span style="font-family:'Cinzel'; color:var(--gold); font-size:0.8rem;">HP</span>
        <div class="hp-track"><div id="hp-bar" class="hp-fill"></div></div>
        <span id="hp-text" style="font-size:0.8rem;">100</span>
    </div>

    <div id="config-screen" class="config-overlay">
        <h1 style="color: var(--gold); text-align: center; margin-bottom: 5px; font-size: 2rem;">CLASS FORGE</h1>
        <p style="color: #666; font-size: 0.7rem; letter-spacing: 3px; margin-bottom: 20px;">PAINEL BETA 1.2</p>
        <div class="config-box">
            <label style="color:var(--gold); font-weight:bold; display:block; margin-bottom:5px;">üìú Mat√©ria</label>
            <select id="subject">
                <option value="">-- MODO LIVRE (Usa PDF abaixo) --</option>
                <option value="Hist√≥ria">Hist√≥ria</option>
                <option value="Matem√°tica">Matem√°tica</option>
                <option value="Geografia">Geografia</option>
                <option value="Ci√™ncias">Ci√™ncias</option>
                <option value="F√≠sica">F√≠sica</option>
                <option value="Qu√≠mica">Qu√≠mica</option>
                <option value="Literatura">Literatura</option>
                <option value="Ingl√™s">Ingl√™s</option>
                <option value="Tecnologia">Tecnologia</option>
                <option value="Conhecimentos Gerais">Conhecimentos Gerais</option>
            </select>
            <label style="color:var(--gold); font-weight:bold; display:block; margin-bottom:5px;">üìÇ Texto ou PDF</label>
            <input type="file" id="fileInput" accept=".pdf, .txt">
            <textarea id="classContent" placeholder="Cole texto aqui se preferir..."></textarea>
            <label style="color:var(--gold); font-weight:bold; display:block; margin-bottom:5px;">‚öîÔ∏è Dificuldade</label>
            <select id="difficulty">
                <option value="3">R√°pido (3 Fases)</option>
                <option value="5" selected>Normal (5 Fases)</option>
                <option value="7">Longo (7 Fases)</option>
            </select>
            <label style="color:var(--gold); font-weight:bold; display:block; margin-bottom:5px;">üîë API Key (Gemini)</label>
            <input type="password" id="apiKey" placeholder="Cole sua chave aqui">
            <button class="btn-main" onclick="initGame(true)">GERAR JOGO (IA)</button>
            <button class="btn-main btn-sec" onclick="showDashboard()">üìä RELAT√ìRIOS</button>
            <button class="btn-main btn-sec" onclick="initGame(false)">MODO DEMO</button>
        </div>
        <div id="loading" class="hidden" style="margin-top: 20px; text-align: center;">
            <div class="loader">‚öôÔ∏è</div><p style="color: var(--gold);">Calculando Fases...</p>
        </div>
    </div>

    <div id="dashboard" class="dashboard-overlay">
        <div class="dash-header"><h2 style="margin:0; color:var(--gold)">Relat√≥rio: 3¬∫ B</h2><button onclick="hideDashboard()" style="background:none; border:1px solid #444; color:#fff; padding:5px 15px; border-radius:4px;">Fechar</button></div>
        <div class="stat-grid"><div class="stat-card"><div class="stat-num">85%</div><div class="stat-label">Engajamento</div></div><div class="stat-card"><div class="stat-num grade-good">9.2</div><div class="stat-label">M√©dia</div></div></div>
        <h3 style="color:#666; margin-bottom:15px; border-left:3px solid var(--gold); padding-left:10px;">Desempenho</h3>
        <table class="student-list"><thead><tr><th>Aluno</th><th>Status</th><th>Nota</th></tr></thead><tbody><tr><td>Ana</td><td style="color:var(--green)">Conclu√≠do</td><td class="grade-good">10.0</td></tr><tr><td>Bruno</td><td style="color:var(--green)">Conclu√≠do</td><td class="grade-good">8.5</td></tr><tr><td>Carla</td><td style="color:orange">Jogando</td><td>-</td></tr></tbody></table>
    </div>

    <div id="game-area"><div id="map-container" class="map-flex"></div></div>

    <div id="battle-modal" class="battle-overlay">
        <div class="battle-window">
            <div class="battle-header"><h2 id="enemy-title" style="margin:0; color: var(--gold); font-size: 1rem;">INIMIGO</h2><button onclick="closeModal()" style="background:none; border:none; color:#666; font-size:1.5rem; padding: 5px 15px;">‚úï</button></div>
            <div class="battle-body" id="battle-body"></div>
        </div>
    </div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let musicInterval = null;

    function playBossMusic() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        if (musicInterval) clearInterval(musicInterval);
        let noteIndex = 0;
        const freedomMotif = [{f: 349.23, d: 0.15}, {f: 415.30, d: 0.15}, {f: 466.16, d: 0.15}, {f: 523.25, d: 0.15}, {f: 554.37, d: 0.15}, {f: 523.25, d: 0.15}, {f: 466.16, d: 0.15}, {f: 415.30, d: 0.15}, {f: 349.23, d: 0.15}, {f: 415.30, d: 0.15}, {f: 523.25, d: 0.15}, {f: 466.16, d: 0.15}];
        musicInterval = setInterval(() => {
            const now = audioCtx.currentTime;
            const noteData = freedomMotif[noteIndex % freedomMotif.length];
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = 'sawtooth'; osc.frequency.value = noteData.f; osc.connect(gain); gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.08, now); gain.gain.exponentialRampToValueAtTime(0.01, now + noteData.d);
            osc.start(now); osc.stop(now + noteData.d);
            if (noteIndex % 4 === 0) { const bass = audioCtx.createOscillator(); const bGain = audioCtx.createGain(); bass.type = 'square'; bass.frequency.value = noteData.f / 2; bass.connect(bGain); bGain.connect(audioCtx.destination); bGain.gain.setValueAtTime(0.05, now); bGain.gain.exponentialRampToValueAtTime(0.01, now + 0.3); bass.start(now); bass.stop(now + 0.3); }
            noteIndex++;
        }, 150);
    }
    function stopBossMusic() { if (musicInterval) { clearInterval(musicInterval); musicInterval = null; } }
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if (type === 'click') { osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(300, now + 0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
        else if (type === 'win') { [523.25, 659.25, 783.99].forEach((freq, i) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type='triangle'; o.frequency.value=freq; g.gain.setValueAtTime(0.1, now+i*0.1); g.gain.exponentialRampToValueAtTime(0.01, now+i*0.1+0.5); o.start(now+i*0.1); o.stop(now+i*0.1+0.5); }); }
        else if (type === 'error') { osc.type='sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now+0.3); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now+0.3); osc.start(now); osc.stop(now+0.3); }
    }

    const canvas = document.getElementById('confetti-canvas'); const ctx = canvas.getContext('2d');
    let confetti = [];
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();
    function startConfetti() { canvas.style.display = 'block'; confetti = Array.from({length: 150}, () => ({ x: Math.random() * canvas.width, y: -Math.random() * canvas.height, color: `hsl(${Math.random()*360}, 100%, 50%)`, size: Math.random()*10+5, speed: Math.random()*3+2, angle: Math.random()*6.2 })); requestAnimationFrame(updateConfetti); }
    function updateConfetti() { ctx.clearRect(0,0,canvas.width,canvas.height); confetti.forEach(p => { p.y += p.speed; p.x += Math.sin(p.angle)*2; p.angle += 0.1; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size); if(p.y > canvas.height) p.y = -10; }); if(canvas.style.display === 'block') requestAnimationFrame(updateConfetti); }

    let playerHP = 100; let adventureData = []; let currentEnemyIndex = -1; let isBusy = false;

    window.addEventListener('DOMContentLoaded', () => {
        const gameArea = document.getElementById('game-area');
        if (gameArea) gameArea.addEventListener('wheel', (evt) => { if(window.innerWidth > 768) { evt.preventDefault(); gameArea.scrollLeft += evt.deltaY; } });
        document.querySelectorAll('button').forEach(b => b.addEventListener('click', () => playSound('click')));
    });

    function performLogin() { playSound('win'); document.getElementById('login-screen').style.display = 'none'; document.getElementById('config-screen').style.display = 'flex'; }
    function showDashboard() { document.getElementById('dashboard').style.display = 'flex'; }
    function hideDashboard() { document.getElementById('dashboard').style.display = 'none'; }

    async function readPDF(file) {
        try { const arrayBuffer = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise; let fullText = ""; const maxPages = Math.min(pdf.numPages, 5); for (let i = 1; i <= maxPages; i++) { const page = await pdf.getPage(i); fullText += (await page.getTextContent()).items.map(i => i.str).join(" ") + " "; } return fullText; } catch (e) { return ""; }
    }
    document.getElementById('fileInput').addEventListener('change', async function(e) { const file = e.target.files[0]; if (file && file.type === "application/pdf") { document.getElementById('classContent').value = "‚è≥ Lendo PDF..."; document.getElementById('classContent').value = await readPDF(file); } });

    function cleanJSON(text) { const firstBracket = text.indexOf('['); const lastBracket = text.lastIndexOf(']'); if (firstBracket === -1 || lastBracket === -1) throw new Error("A IA n√£o retornou uma lista v√°lida."); return text.substring(firstBracket, lastBracket + 1); }

    async function initGame(useRealAI) {
        try {
            const content = document.getElementById('classContent').value;
            const apiKey = document.getElementById('apiKey').value;
            // FIX DA QUANTIDADE: Pega o valor exato (3, 5 ou 7)
            const totalStages = parseInt(document.getElementById('difficulty').value);
            const subject = document.getElementById('subject').value;

            if (subject === "" && (!content || content.length < 10 || content === "‚è≥ Lendo PDF...")) { alert("‚ö†Ô∏è Para MODO LIVRE, insira um PDF ou texto."); return; }
            if (useRealAI && !apiKey) { alert("‚ö†Ô∏è Falta API Key!"); return; }

            document.querySelector('.config-box').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');

            if (useRealAI) {
                let context = subject === "" ? `Baseie-se ESTRITAMENTE neste texto: "${content.substring(0, 3000)}"` : `Mat√©ria: ${subject}. Texto apoio: "${content.substring(0, 2000)}"`;
                // FIX DA QUANTIDADE NO PROMPT: "EXATAMENTE ${totalStages}"
                // FIX DA FURTIVIDADE: Pedindo "hint"
                const prompt = `ATUE COMO MESTRE DE RPG. ${context} 
                OBJETIVO: Gerar lista JSON com EXATAMENTE ${totalStages} objetos. (O √∫ltimo deve ser 'type: boss').
                
                REGRAS: 
                1. 'desc': Lore envolvente.
                2. RIGOR FACTUAL: Verifique fatos e contas.
                3. STEALTH UPDATE: Adicione campo 'hint' (Contexto/Pergunta) e 'phrase' (Resposta curta).
                
                FORMATO JSON: 
                [
                    {"title": "Inimigo", "type": "enemy", "desc": "...", 
                     "quiz": {"question": "...", "options": ["A","B","C"], "correct": 1}, 
                     "magic": {"statement": "...", "is_true": true}, 
                     "stealth": {"hint": "Contexto da frase...", "phrase": "Frase resposta"}
                    }, 
                    ... (Total de ${totalStages} itens)
                ]`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                adventureData = JSON.parse(cleanJSON(data.candidates[0].content.parts[0].text));
                
                // Trava de Seguran√ßa: Se vier menos, duplica o ultimo at√© dar o total
                while (adventureData.length < totalStages) {
                    adventureData.push(JSON.parse(JSON.stringify(adventureData[adventureData.length-1])));
                }

            } else {
                await new Promise(r => setTimeout(r, 1500));
                adventureData = getDemoData(totalStages);
            }

            document.getElementById('config-screen').classList.add('hidden');
            document.getElementById('game-area').style.display = 'block';
            document.getElementById('game-hud').style.display = 'flex';
            renderMap();
        } catch (error) {
            console.error(error); alert("Erro: " + error.message + "\nCarregando demo.");
            adventureData = getDemoData(3);
            document.getElementById('config-screen').classList.add('hidden');
            document.getElementById('game-area').style.display = 'block';
            document.getElementById('game-hud').style.display = 'flex';
            renderMap();
        }
    }

    function renderMap() {
        const container = document.getElementById('map-container'); container.innerHTML = "";
        adventureData.forEach((node, index) => {
            if (index > 0) container.appendChild(document.createElement('div')).className = 'connector';
            const card = document.createElement('div');
            const isLocked = index > 0 && !adventureData[index-1].completed;
            card.className = `card ${node.type} ${node.completed ? 'cleared' : ''} ${isLocked ? 'locked' : ''}`;
            card.onclick = function() { if (!isLocked && !node.completed && !isBusy) openBattleSelector(index); };
            let icon = node.type === 'boss' ? 'üê≤' : 'üíÄ'; if (node.completed) icon = 'üõ°Ô∏è';
            card.innerHTML = `<div class="card-icon">${icon}</div><div class="card-title">${node.title}</div><div class="card-desc">${node.desc || "..."}</div>`;
            container.appendChild(card);
        });
    }

    function openBattleSelector(index) {
        currentEnemyIndex = index;
        const node = adventureData[index];
        const isBoss = node.type === 'boss';
        document.getElementById('enemy-title').innerText = node.title.toUpperCase();
        
        if (isBoss) { document.body.classList.add('boss-mode'); playBossMusic(); } else { document.body.classList.remove('boss-mode'); }
        document.getElementById('battle-modal').style.display = 'flex';
        
        const loreHTML = `<div class="lore-box">"${node.desc || 'Desafio...'}"</div>`;
        if (isBoss) { document.getElementById('battle-body').innerHTML = loreHTML; renderCombat('quiz', true); return; }
        document.getElementById('battle-body').innerHTML = `${loreHTML}<div class="combat-selector"><div class="combat-option" onclick="renderCombat('quiz')"><div class="combat-icon">‚öîÔ∏è</div><div class="combat-info"><h3>COMBATE</h3><p>Quiz</p></div></div><div class="combat-option" onclick="renderCombat('magic')"><div class="combat-icon">‚ú®</div><div class="combat-info"><h3>MAGIA</h3><p>V ou F</p></div></div><div class="combat-option" onclick="renderCombat('stealth')"><div class="combat-icon">üß©</div><div class="combat-info"><h3>FURTIVO</h3><p>Puzzle</p></div></div></div>`;
    }

    function renderCombat(mode, isBoss = false) {
        playSound('click');
        const node = adventureData[currentEnemyIndex];
        const body = document.getElementById('battle-body');
        if (!body.innerHTML.includes('lore-box')) { const loreHTML = `<div class="lore-box">"${node.desc}"</div>`; body.innerHTML = loreHTML + body.innerHTML; }
        let html = `<div id="feedback-area"></div>`;

        if (mode === 'quiz') {
            html += `<p class="question-text">${node.quiz.question}</p>`;
            if (isBoss && (!node.quiz.options || node.quiz.options.length === 0)) { html += `<div style="text-align:center;color:#888;margin-bottom:20px;"><em>Gab: ${node.quiz.correct}</em></div><button class="btn-main" onclick="resolveBattle(true)">VENCER</button>`; }
            else { node.quiz.options.forEach((opt, i) => html += `<button class="quiz-btn" onclick="checkQuiz(${i}, ${node.quiz.correct})">${opt}</button>`); }
        } else if (mode === 'magic') {
            html += `<p class="question-text" style="text-align:center;">"${node.magic.statement}"</p><button class="btn-main" onclick="checkMagic(true, ${node.magic.is_true})">VERDADEIRO</button><button class="btn-main" style="background:#222;margin-top:15px;" onclick="checkMagic(false, ${node.magic.is_true})">FALSO</button>`;
        } else if (mode === 'stealth') {
            const phrase = node.stealth.phrase; 
            const hint = node.stealth.hint || "Organize a frase corretamente:"; // Fallback se n√£o tiver hint
            const shuffled = phrase.split(' ').sort(() => Math.random() - 0.5);
            // DISPLAY DA DICA (HINT)
            html += `<p style="text-align:center;color:#gold;font-style:italic;margin-bottom:10px;">"${hint}"</p>
                     <div class="answer-area" id="puzzle-answer"></div>
                     <div class="word-bank" id="puzzle-bank"></div>
                     <button class="btn-main" id="check-puzzle-btn" onclick="checkPuzzle('${phrase}')" style="opacity:0.5;margin-top:20px;">HACKEAR</button>`;
            setTimeout(() => { const bank = document.getElementById('puzzle-bank'); shuffled.forEach(w => { const span = document.createElement('span'); span.className = 'word-slot'; span.innerText = w; span.onclick = function() { moveWord(this); }; bank.appendChild(span); }); }, 50);
        }
        
        const existingLore = body.querySelector('.lore-box'); body.innerHTML = ""; if(existingLore) body.appendChild(existingLore);
        const contentDiv = document.createElement('div'); contentDiv.innerHTML = html; body.appendChild(contentDiv);
        if(!isBoss) { const backBtn = document.createElement('button'); backBtn.innerHTML = "VOLTAR"; backBtn.style = "width:100%;padding:15px;background:none;border:none;color:#666;margin-top:15px;"; backBtn.onclick = () => openBattleSelector(currentEnemyIndex); body.appendChild(backBtn); }
    }

    function moveWord(el) { playSound('click'); const bank = document.getElementById('puzzle-bank'); const answer = document.getElementById('puzzle-answer'); (el.parentElement === bank ? answer : bank).appendChild(el); document.getElementById('check-puzzle-btn').style.opacity = '1'; }
    function showFeedback(msg, isGood) { const area = document.getElementById('feedback-area'); area.innerText = msg; area.className = isGood ? 'correct' : 'wrong'; area.style.color = isGood ? 'var(--green)' : 'var(--red)'; area.style.border = isGood ? '1px solid var(--green)' : '1px solid var(--red)'; }
    function checkPuzzle(t) { const u = Array.from(document.getElementById('puzzle-answer').children).map(s => s.innerText).join(' '); (u.replace(/\s+/g,'').toLowerCase() === t.replace(/\s+/g,'').toLowerCase()) ? (showFeedback("HACKEADO!", true), winEffect(document.getElementById('check-puzzle-btn'))) : (showFeedback("ERRO! (-15 HP)", false), loseEffect(document.getElementById('check-puzzle-btn'))); }
    function checkQuiz(s, c) { const btns = document.querySelectorAll('.quiz-btn'); s === c ? (showFeedback("CORRETO!", true), winEffect(btns[s])) : (showFeedback("ERRADO! (-15 HP)", false), loseEffect(btns[s])); }
    function checkMagic(u, c) { const t = u ? document.querySelectorAll('.btn-main')[0] : document.querySelectorAll('.btn-main')[1]; u === c ? (showFeedback("CORRETO!", true), winEffect(t)) : (showFeedback("ERRADO! (-15 HP)", false), loseEffect(t)); }

    function winEffect(el) { if(!el) return; playSound('win'); el.classList.add('correct'); isBusy = true; setTimeout(() => { resolveBattle(true); isBusy = false; }, 1000); }
    function loseEffect(el) { if(!el) return; playSound('error'); el.classList.add('wrong'); updateHP(-15); setTimeout(() => el.classList.remove('wrong'), 1000); }
    
    function resolveBattle(win) {
        if(win) {
            adventureData[currentEnemyIndex].completed = true;
            document.body.classList.remove('boss-mode'); stopBossMusic();
            document.getElementById('battle-modal').style.display = 'none';
            renderMap();
            if(adventureData.every(n => n.completed)) {
                startConfetti();
                setTimeout(() => alert("üèÜ VIT√ìRIA! VOC√ä ZEROU A MAT√âRIA!"), 500);
            }
        }
    }
    function updateHP(amt) { playerHP += amt; if(playerHP < 0) playerHP = 0; document.getElementById('hp-bar').style.width = playerHP + '%'; document.getElementById('hp-text').innerText = playerHP; if (playerHP === 0) { alert("üíÄ GAME OVER! Tente novamente."); location.reload(); } }
    function closeModal() { document.body.classList.remove('boss-mode'); stopBossMusic(); document.getElementById('battle-modal').style.display = 'none'; }
    function getDemoData(d) { return Array(d).fill(0).map((_, i) => ({ title: i===d-1?"Rei do Caos":"Inimigo", desc: "Lore de teste...", type: i===d-1?"boss":"enemy", completed: false, quiz: { question: "1+1?", options: ["2","3"], correct: 0 }, magic: { statement: "Sol √© gelado?", is_true: false }, stealth: { phrase: "Eu sou legal", hint: "Quem sou eu?" } })); }
</script>
</body>
</html>
